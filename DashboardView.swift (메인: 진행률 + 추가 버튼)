import SwiftUI

struct DashboardView: View {
    @EnvironmentObject private var vm: WaterTrackerViewModel

    var body: some View {
        VStack(spacing: 24) {
            Text("ì˜¤ëŠ˜ì˜ ë¬¼ ì„­ì·¨")
                .font(.title2).bold()

            // ì›í˜• ì§„í–‰ë¥ 
            CircularProgressView(progress: vm.today.progress)
                .frame(width: 180, height: 180)

            VStack(spacing: 6) {
                Text("\(vm.today.totalML) / \(vm.today.goalML) ml")
                    .font(.headline)
                Text(vm.today.isAchieved ? "ëª©í‘œ ë‹¬ì„±! ðŸŽ‰" : "ë‚¨ì€ ì–‘ \(vm.today.remainingML) ml")
                    .foregroundStyle(vm.today.isAchieved ? .blue : .secondary)
            }

            HStack(spacing: 12) {
                ForEach([vm.settings.stepML/2, vm.settings.stepML, vm.settings.stepML*2].uniquePositive(), id: \.self) { step in
                    Button("+\(step)ml") {
                        vm.addDrink(amount: step)
                    }
                    .buttonStyle(.borderedProminent)
                }
            }
            .padding(.top, 8)

            Divider().padding(.vertical, 8)

            // ìµœê·¼ 5ê°œ ê°„ë‹¨ í‘œì‹œ
            VStack(alignment: .leading, spacing: 8) {
                Text("ìµœê·¼ ê¸°ë¡")
                    .font(.headline)
                if vm.today.entries.isEmpty {
                    Text("ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ì•„ëž˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.")
                        .foregroundStyle(.secondary)
                } else {
                    ForEach(vm.today.entries.sorted(by: { $0.timestamp > $1.timestamp }).prefix(5)) { e in
                        HStack {
                            Text(e.timestamp.formattedTime())
                            Spacer()
                            Text("\(e.amountML) ml")
                        }
                        .font(.subheadline)
                    }
                }
            }
            .padding(.horizontal)

            Spacer(minLength: 0)
        }
        .padding()
        .onAppear { vm.resetIfNeeded() }
    }
}

private extension Array where Element == Int {
    func uniquePositive() -> [Int] {
        Array(Set(self.filter { $0 > 0 })).sorted()
    }
}
